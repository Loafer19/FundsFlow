<template>
    <dialog id="auth_modal" class="modal">
        <div class="modal-box max-w-sm">
            <div class="tabs tabs-box justify-center mb-4">
                <a class="tab tab-bordered" :class="{ 'tab-active': !isRegister }" @click="isRegister = false">Login</a>
                <a class="tab tab-bordered" :class="{ 'tab-active': isRegister }"
                    @click="isRegister = true">Register</a>
            </div>

            <h2 class="card-title mb-4">
                <svg v-if="isRegister" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M5.25001 6C5.25001 3.37665 7.37666 1.25 10 1.25C12.6234 1.25 14.75 3.37665 14.75 6C14.75 8.62335 12.6234 10.75 10 10.75C7.37666 10.75 5.25001 8.62335 5.25001 6ZM10 2.75C8.20509 2.75 6.75001 4.20507 6.75001 6C6.75001 7.79493 8.20509 9.25 10 9.25C11.7949 9.25 13.25 7.79493 13.25 6C13.25 4.20507 11.7949 2.75 10 2.75Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M3.97546 13.6643C5.55494 12.7759 7.68646 12.25 10 12.25C12.3136 12.25 14.4451 12.7759 16.0246 13.6643C17.5805 14.5396 18.75 15.8661 18.75 17.5L18.7501 17.602C18.7512 18.7638 18.7526 20.222 17.4736 21.2635C16.8441 21.7761 15.9635 22.1406 14.7738 22.3815C13.5808 22.6229 12.0258 22.75 10 22.75C7.97424 22.75 6.41927 22.6229 5.22622 22.3815C4.03649 22.1406 3.15589 21.7761 2.52642 21.2635C1.2474 20.222 1.24882 18.7638 1.24995 17.602L1.25001 17.5C1.25001 15.8661 2.4195 14.5396 3.97546 13.6643ZM4.71085 14.9717C3.37139 15.7251 2.75001 16.6487 2.75001 17.5C2.75001 18.8078 2.79033 19.544 3.4736 20.1004C3.84413 20.4022 4.46354 20.6967 5.5238 20.9113C6.58075 21.1252 8.02579 21.25 10 21.25C11.9742 21.25 13.4193 21.1252 14.4762 20.9113C15.5365 20.6967 16.1559 20.4022 16.5264 20.1004C17.2097 19.544 17.25 18.8078 17.25 17.5C17.25 16.6487 16.6286 15.7251 15.2892 14.9717C13.9732 14.2315 12.1047 13.75 10 13.75C7.89529 13.75 6.02681 14.2315 4.71085 14.9717Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M16.6903 7.44694C17.4109 7.12802 18.2479 7.18847 19 7.67889C19.7522 7.18847 20.5891 7.12802 21.3098 7.44694C22.1648 7.82533 22.75 8.69929 22.75 9.69973C22.75 10.6481 22.3358 11.362 21.8395 11.9031C21.4521 12.3254 20.9729 12.682 20.5945 12.9636C20.5132 13.0241 20.4366 13.0812 20.3665 13.1347L20.3645 13.1362C20.2158 13.2497 20.0235 13.3965 19.8207 13.5111C19.6168 13.6265 19.3344 13.75 19 13.75C18.6657 13.75 18.3832 13.6265 18.1793 13.5111C17.9765 13.3965 17.7842 13.2497 17.6355 13.1362L17.6335 13.1347C17.5635 13.0812 17.4869 13.0242 17.4057 12.9638C17.0273 12.6821 16.5479 12.3254 16.1606 11.9031C15.6642 11.362 15.25 10.6481 15.25 9.69973C15.25 8.69929 15.8352 7.82533 16.6903 7.44694ZM16.75 9.69973C16.75 9.28775 16.9898 8.95469 17.2973 8.81862C17.5635 8.7008 17.9874 8.68874 18.4681 9.17232C18.6089 9.31392 18.8003 9.39354 19 9.39354C19.1997 9.39354 19.3911 9.31392 19.5319 9.17232C20.0126 8.68874 20.4365 8.7008 20.7027 8.81862C21.0102 8.95469 21.25 9.28775 21.25 9.69973C21.25 10.1638 21.0613 10.5324 20.7341 10.8891C20.4521 11.1966 20.1157 11.448 19.7438 11.7259C19.6502 11.7959 19.5543 11.8676 19.4565 11.9423C19.294 12.0663 19.1814 12.1495 19.0821 12.2056C19.0421 12.2283 19.0153 12.2399 19 12.2456C18.9847 12.2399 18.958 12.2283 18.9179 12.2056C18.8187 12.1495 18.7061 12.0663 18.5436 11.9423C18.4457 11.8676 18.3499 11.796 18.2563 11.726C17.8844 11.448 17.548 11.1966 17.266 10.8891C16.9387 10.5324 16.75 10.1638 16.75 9.69973Z" />
                </svg>
                <svg v-else width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M12 1.25C9.37666 1.25 7.25001 3.37665 7.25001 6C7.25001 8.62335 9.37666 10.75 12 10.75C14.6234 10.75 16.75 8.62335 16.75 6C16.75 3.37665 14.6234 1.25 12 1.25ZM8.75001 6C8.75001 4.20507 10.2051 2.75 12 2.75C13.7949 2.75 15.25 4.20507 15.25 6C15.25 7.79493 13.7949 9.25 12 9.25C10.2051 9.25 8.75001 7.79493 8.75001 6Z" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M12 12.25C9.68646 12.25 7.55494 12.7759 5.97546 13.6643C4.4195 14.5396 3.25001 15.8661 3.25001 17.5L3.24995 17.602C3.24882 18.7638 3.2474 20.222 4.52642 21.2635C5.15589 21.7761 6.03649 22.1406 7.22622 22.3815C8.41927 22.6229 9.97424 22.75 12 22.75C14.0258 22.75 15.5808 22.6229 16.7738 22.3815C17.9635 22.1406 18.8441 21.7761 19.4736 21.2635C20.7526 20.222 20.7512 18.7638 20.7501 17.602L20.75 17.5C20.75 15.8661 19.5805 14.5396 18.0246 13.6643C16.4451 12.7759 14.3136 12.25 12 12.25ZM4.75001 17.5C4.75001 16.6487 5.37139 15.7251 6.71085 14.9717C8.02681 14.2315 9.89529 13.75 12 13.75C14.1047 13.75 15.9732 14.2315 17.2892 14.9717C18.6286 15.7251 19.25 16.6487 19.25 17.5C19.25 18.8078 19.2097 19.544 18.5264 20.1004C18.1559 20.4022 17.5365 20.6967 16.4762 20.9113C15.4193 21.1252 13.9742 21.25 12 21.25C10.0258 21.25 8.58075 21.1252 7.5238 20.9113C6.46354 20.6967 5.84413 20.4022 5.4736 20.1004C4.79033 19.544 4.75001 18.8078 4.75001 17.5Z" />
                </svg>
                {{ isRegister ? 'Register' : 'Login' }}
            </h2>

            <form @submit.prevent="handleSubmit">
                <input v-if="isRegister" type="text" v-model="credentials.name" placeholder="Name"
                    class="input w-full mb-4" required />

                <input type="text" v-model="credentials.email" placeholder="Email" class="input w-full mb-4" required />

                <input type="password" v-model="credentials.password" placeholder="Password" class="input w-full"
                    required />

                <div class="modal-action justify-between">
                    <div class="flex gap-2">
                        <a :href="googleAuthUrl" class="btn btn-ghost btn-square">
                            <svg height="30" width="30" viewBox="-0.5 0 48 48" version="1.1">
                                <path
                                    d="M9.82727273,24 C9.82727273,22.4757333 10.0804318,21.0144 10.5322727,19.6437333 L2.62345455,13.6042667 C1.08206818,16.7338667 0.213636364,20.2602667 0.213636364,24 C0.213636364,27.7365333 1.081,31.2608 2.62025,34.3882667 L10.5247955,28.3370667 C10.0772273,26.9728 9.82727273,25.5168 9.82727273,24"
                                    fill="#FBBC05">
                                </path>
                                <path
                                    d="M23.7136364,10.1333333 C27.025,10.1333333 30.0159091,11.3066667 32.3659091,13.2266667 L39.2022727,6.4 C35.0363636,2.77333333 29.6954545,0.533333333 23.7136364,0.533333333 C14.4268636,0.533333333 6.44540909,5.84426667 2.62345455,13.6042667 L10.5322727,19.6437333 C12.3545909,14.112 17.5491591,10.1333333 23.7136364,10.1333333"
                                    fill="#EB4335">
                                </path>
                                <path
                                    d="M23.7136364,37.8666667 C17.5491591,37.8666667 12.3545909,33.888 10.5322727,28.3562667 L2.62345455,34.3946667 C6.44540909,42.1557333 14.4268636,47.4666667 23.7136364,47.4666667 C29.4455,47.4666667 34.9177955,45.4314667 39.0249545,41.6181333 L31.5177727,35.8144 C29.3995682,37.1488 26.7323182,37.8666667 23.7136364,37.8666667"
                                    fill="#34A853">
                                </path>
                                <path
                                    d="M46.1454545,24 C46.1454545,22.6133333 45.9318182,21.12 45.6113636,19.7333333 L23.7136364,19.7333333 L23.7136364,28.8 L36.3181818,28.8 C35.6879545,31.8912 33.9724545,34.2677333 31.5177727,35.8144 L39.0249545,41.6181333 C43.3393409,37.6138667 46.1454545,31.6490667 46.1454545,24"
                                    fill="#4285F4">
                                </path>
                            </svg>
                        </a>
                        <a :href="githubAuthUrl" class="btn btn-ghost btn-square">
                            <svg height="33" width="33" viewBox="0 0 24 24" version="1.1">
                                <path
                                    d="M12 1C5.9225 1 1 5.9225 1 12C1 16.8675 4.14875 20.9787 8.52125 22.4362C9.07125 22.5325 9.2775 22.2025 9.2775 21.9137C9.2775 21.6525 9.26375 20.7862 9.26375 19.865C6.5 20.3737 5.785 19.1912 5.565 18.5725C5.44125 18.2562 4.905 17.28 4.4375 17.0187C4.0525 16.8125 3.5025 16.3037 4.42375 16.29C5.29 16.2762 5.90875 17.0875 6.115 17.4175C7.105 19.0812 8.68625 18.6137 9.31875 18.325C9.415 17.61 9.70375 17.1287 10.02 16.8537C7.5725 16.5787 5.015 15.63 5.015 11.4225C5.015 10.2262 5.44125 9.23625 6.1425 8.46625C6.0325 8.19125 5.6475 7.06375 6.2525 5.55125C6.2525 5.55125 7.17375 5.2625 9.2775 6.67875C10.1575 6.43125 11.0925 6.3075 12.0275 6.3075C12.9625 6.3075 13.8975 6.43125 14.7775 6.67875C16.8813 5.24875 17.8025 5.55125 17.8025 5.55125C18.4075 7.06375 18.0225 8.19125 17.9125 8.46625C18.6138 9.23625 19.04 10.2125 19.04 11.4225C19.04 15.6437 16.4688 16.5787 14.0213 16.8537C14.42 17.1975 14.7638 17.8575 14.7638 18.8887C14.7638 20.36 14.75 21.5425 14.75 21.9137C14.75 22.2025 14.9563 22.5462 15.5063 22.4362C19.8513 20.9787 23 16.8537 23 12C23 5.9225 18.0775 1 12 1Z">
                                </path>
                            </svg>
                        </a>
                    </div>

                    <button type="submit" class="btn btn-success" :disabled="authStore.isLoading">
                        <span v-if="authStore.isLoading" class="loading loading-spinner"></span>

                        {{ isRegister ? 'Register' : 'Login' }}

                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M12 1.25C9.37666 1.25 7.25001 3.37665 7.25001 6C7.25001 8.62335 9.37666 10.75 12 10.75C14.6234 10.75 16.75 8.62335 16.75 6C16.75 3.37665 14.6234 1.25 12 1.25ZM8.75001 6C8.75001 4.20507 10.2051 2.75 12 2.75C13.7949 2.75 15.25 4.20507 15.25 6C15.25 7.79493 13.7949 9.25 12 9.25C10.2051 9.25 8.75001 7.79493 8.75001 6Z" />
                            <path
                                d="M19.8555 14.5729C20.1528 14.8614 20.1599 15.3362 19.8714 15.6334L18.0382 17.5223C17.8901 17.6749 17.6842 17.7575 17.4717 17.7495C17.2592 17.7414 17.0601 17.6436 16.9239 17.4802L16.0904 16.4802C15.8252 16.162 15.8681 15.6891 16.1863 15.4239C16.5045 15.1587 16.9774 15.2016 17.2426 15.5198L17.5424 15.8794L18.795 14.5888C19.0835 14.2915 19.5583 14.2844 19.8555 14.5729Z" />
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M14.7747 12.5129C13.9019 12.3421 12.9685 12.25 12 12.25C9.68646 12.25 7.55494 12.7759 5.97546 13.6643C4.41949 14.5396 3.25001 15.8661 3.25001 17.5L3.24995 17.602C3.24882 18.7638 3.2474 20.222 4.52642 21.2635C5.15589 21.7761 6.03649 22.1406 7.22622 22.3815C8.41927 22.6229 9.97424 22.75 12 22.75C14.8681 22.75 16.8099 22.4961 18.1196 22.0085C19.2985 21.5697 19.9973 20.9266 20.3704 20.1172C21.7927 19.2966 22.75 17.7601 22.75 16C22.75 13.3766 20.6234 11.25 18 11.25C16.7549 11.25 15.6217 11.7291 14.7747 12.5129ZM14.75 16C14.75 14.2051 16.2051 12.75 18 12.75C19.7949 12.75 21.25 14.2051 21.25 16C21.25 17.7949 19.7949 19.25 18 19.25C16.2051 19.25 14.75 17.7949 14.75 16ZM13.7557 13.865C13.4322 14.5069 13.25 15.2322 13.25 16C13.25 18.3893 15.0141 20.3666 17.3108 20.7004C16.2401 21.0366 14.578 21.25 12 21.25C10.0258 21.25 8.58075 21.1252 7.5238 20.9113C6.46354 20.6967 5.84413 20.4022 5.4736 20.1004C4.79033 19.544 4.75001 18.8078 4.75001 17.5C4.75001 16.6487 5.37139 15.7251 6.71085 14.9717C8.02681 14.2315 9.89529 13.75 12 13.75C12.6061 13.75 13.194 13.79 13.7557 13.865Z" />
                        </svg>
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
</template>

<script setup>
import { inject, ref, watch } from 'vue'
import { useAuthStore } from './../services/auth.js'

const googleAuthUrl = import.meta.env.VITE_API_URL + '/auth/google'
const githubAuthUrl = import.meta.env.VITE_API_URL + '/auth/github'

const authStore = useAuthStore()
const toasts = inject('toasts')

const isRegister = ref(false)

const credentials = ref({
    name: '',
    email: '',
    password: '',
})

watch(
    () => new URLSearchParams(window.location.search).get('token'),
    async (token) => {
        if (token) {
            authStore.setToken(token)
            window.history.replaceState({}, '', window.location.pathname)
        }
    },
    { immediate: true },
)

watch(
    () => authStore.toast,
    (toast) => {
        if (toast) {
            toasts.push(toast)

            authStore.toast = null
        }
    },
)

const handleSubmit = async () => {
    if (isRegister.value) {
        await authStore.register(credentials.value)
    } else {
        await authStore.login(credentials.value)
    }

    if (authStore.isAuthenticated) {
        credentials.value = { name: '', email: '', password: '' }

        auth_modal.close()
    }
}
</script>
